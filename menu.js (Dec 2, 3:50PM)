document.addEventListener("DOMContentLoaded", () => {
    const itemCards = document.querySelectorAll(".item-card");
    const cartCount = document.getElementById("cart-count");
    const cartIcon = document.querySelector(".cart-display");
    const cartPreview = document.getElementById("cart-preview");
    const cartItemsList = document.getElementById("cart-items");
    const cartTotalDisplay = document.getElementById("cart-total");
    const doneButton = document.querySelector(".done-button");

    let cart = [];

    function updateCartDisplay() {
        const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCount.textContent = totalQty;
    }

    function renderCartPreview() {
        cartItemsList.innerHTML = "";

        if (!cart.length) {
            const li = document.createElement("li");
            li.textContent = "Cart is empty";
            cartItemsList.appendChild(li);
            cartTotalDisplay.textContent = "0.00";
            return;
        }

        let total = 0;

        cart.forEach(item => {
            total += item.price * item.quantity;

            const li = document.createElement("li");
            li.textContent = `${item.name} x${item.quantity}`;
            const priceSpan = document.createElement("span");
            priceSpan.textContent = `$${(item.price * item.quantity).toFixed(2)}`;

            li.appendChild(priceSpan);
            cartItemsList.appendChild(li);
        });

        cartTotalDisplay.textContent = total.toFixed(2);
    }

    function syncCartUI() {
        updateCartDisplay();
        renderCartPreview();
    }

    //renders the cart by clicking the emoji
    if (cartIcon && cartPreview) {
        cartIcon.addEventListener("click", () => {
            // 1. Update the cart contents first
            renderCartPreview(); 
            
            // 2. Then, toggle the visibility using the class
            cartPreview.classList.toggle("hidden");
        });
    }

    // Attach plus/minus handlers for each item card
    itemCards.forEach(card => {
        const name = card.querySelector("h3").textContent;
        const priceText = card.querySelector(".price").textContent;
        const price = parseFloat(priceText.replace("$", ""));

        const minusBtn = card.querySelector(".qty-minus");
        const plusBtn = card.querySelector(".qty-plus");
        const qtySpan = card.querySelector(".qty-value");

        const getQty = () => parseInt(qtySpan.textContent, 10) || 0;

        function updateCartItem(quantity) {
            const existing = cart.find(item => item.name === name);
            if (existing) {
                existing.quantity = quantity;
                if (existing.quantity <= 0) {
                    cart = cart.filter(item => item.name !== name);
                }
            } else if (quantity > 0) {
                cart.push({ name, price, quantity });
            }
            syncCartUI();
        }

        plusBtn.addEventListener("click", () => {
            const newQty = getQty() + 1;
            qtySpan.textContent = newQty;
            updateCartItem(newQty);
        });

        minusBtn.addEventListener("click", () => {
            const current = getQty();
            if (current <= 0) return;
            const newQty = current - 1;
            qtySpan.textContent = newQty;
            updateCartItem(newQty);
        });
    });

    if (doneButton) {
        doneButton.addEventListener("click", () => {
            //turns the html cart information into JSON
            const cartJSON = JSON.stringify(cart); 

            // 2. Save the string to localStorage under a key (e.g., 'savedCart')
            localStorage.setItem("savedCart", cartJSON);
            window.location.href = "receipt.html";
        });
    }

});

function togglePreview() {
    const previewElement = document.getElementById('cart-preview');
    
    if (previewElement) {
        // This handles the simple visibility toggle for the "Close" button
        previewElement.classList.toggle('hidden');
    } else {
        console.error('Element with ID "cart-preview" not found.');
    }
}
